name: anonymize import 

on:
  workflow_dispatch:

jobs:
  import:
    runs-on: ubuntu-latest
    env:
      TARGET_REPO: benjaminampereza/melodIQ
      COMMIT_NAME: "benjaminampereza"
      COMMIT_EMAIL: "benjaminampereza@users.noreply.github.com"
      COMMIT_MSG: "Initial import from Melody-Minds (authors removed)"
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare anonymized copy
        run: |
          set -euo pipefail
          SRC_DIR="$GITHUB_WORKSPACE"
          IMPORT_DIR="$GITHUB_WORKSPACE/mm-import"
          rm -rf "$IMPORT_DIR"
          mkdir -p "$IMPORT_DIR"
          # Copy working tree excluding .git
          rsync -a --delete --exclude='.git' "$SRC_DIR/" "$IMPORT_DIR/"

          # Remove AUTHORS/CONTRIBUTORS files (case-insensitive)
          find "$IMPORT_DIR" -type f \( -iname 'authors' -o -iname 'authors.*' -o -iname 'contributors' -o -iname 'contributors.*' \) -print0 | xargs -0 -r rm -f || true

          # Scrub text files: remove header lines and personal info (emails, @mentions, Maintainer/Owner lines)
          find "$IMPORT_DIR" -type f -print0 | while IFS= read -r -d '' f; do
            mimetype=$(file --mime-type -b "$f" || echo "")
            if echo "$mimetype" | grep -qiE '^text/|/(json|xml|javascript|x-python|x-shellscript)$'; then
              # Remove author-like lines and strip email-like tokens and @mentions (aggressive)
              perl -0777 -pe '
                s/^[ \t]*(Author:|Created by:|By:|Maintainer:|Owner:).*?$[\r\n]*//gim;
                s/[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}//g;
                s/@[A-Za-z0-9._-]{1,39}//g;
              ' -i "$f" || true
            fi
          done

          # Update LICENSE/COPYRIGHT files
          find "$IMPORT_DIR" -type f \( -iname 'license*' -o -iname 'copyright*' \) -print0 | while IFS= read -r -d '' lic; do
            if grep -Iq '^copyright' "$lic"; then
              awk 'BEGIN{printed=0} /^[[:space:]]*Copyright/i { if(!printed){print "Copyright (c) 2025 benjaminampereza"; printed=1}; next } {print}' "$lic" > "$lic.tmp" && mv "$lic.tmp" "$lic"
            else
              { echo "Copyright (c) 2025 benjaminampereza"; cat "$lic"; } > "$lic.tmp" && mv "$lic.tmp" "$lic"
            fi
          done

          # Create import-report.txt
          REPORT="$GITHUB_WORKSPACE/import-report.txt"
          echo "Anonymized import report" > "$REPORT"
          echo "" >> "$REPORT"
          echo "Removed AUTHORS/CONTRIBUTORS (paths in source):" >> "$REPORT"
          find "$SRC_DIR" -type f \( -iname 'authors' -o -iname 'authors.*' -o -iname 'contributors' -o -iname 'contributors.*' \) -print >> "$REPORT" || true
          echo "" >> "$REPORT"
          echo "Prepared import directory: $IMPORT_DIR" >> "$REPORT"
          echo "" >> "$REPORT"
          echo "Please inspect mm-import and this report artifact before allowing the workflow to push in a production run." >> "$REPORT"

      - name: Create single-commit repository
        run: |
          set -euo pipefail
          cd "$GITHUB_WORKSPACE/mm-import"
          rm -rf .git || true
          git init -b main
          git add --all
          git config user.name "${COMMIT_NAME}"
          git config user.email "${COMMIT_EMAIL}"
          export GIT_COMMITTER_NAME="${COMMIT_NAME}"
          export GIT_COMMITTER_EMAIL="${COMMIT_EMAIL}"
          git commit --author="${COMMIT_NAME} <${COMMIT_EMAIL}>" -m "${COMMIT_MSG}" || true

      - name: Push to target repository
        if: ${{ secrets.TARGET_TOKEN != '' }}
        env:
          TARGET_TOKEN: ${{ secrets.TARGET_TOKEN }}
        run: |
          set -euo pipefail
          cd "$GITHUB_WORKSPACE/mm-import"
          TARGET="https://x-access-token:${TARGET_TOKEN}@github.com/${{ env.TARGET_REPO }}.git"
          git remote add origin "$TARGET"
          git push -u origin main --force

      - name: Upload anonymized copy and report
        uses: actions/upload-artifact@v4
        with:
          name: anonymized-import
          path: |
            mm-import
            import-report.txt
